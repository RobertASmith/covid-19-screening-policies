---
title: "Policy Evaluation for Reopening of Schools"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)
library(tidygraph)
library(ggraph)
library(pscl)

source("code/util.R")

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
Pkg.instantiate()
Pkg.precompile()

using cov19sim, DataFrames, Distributions

# load environment on worker processors
using Distributed
addprocs(min(4, Sys.CPU_THREADS)) # memory limitations...
@everywhere begin 
	using Pkg
	Pkg.activate(".julia")
	using cov19sim, DataFrames, Distributions
	include("code/school.jl")
	include("code/simulate.jl")
end
```



# Problem Statement

The ongoing Covid-19 pandemic in the United Kingdom made nationwide lockdowns
of schools a reality in late 2020 and early 2021.
Such drastic policies are particularly burdensome for families with young
children who cannot effectively attend remote schooling.
The availability of cheap screening tests opens the opportunity of a more
nuanced approach to reopening at least nurseries and primary schools.
However, the impact of the various screening and isolation policies on key
performance indicators is not well understood.



# Policies 

For all policies, we assume that a 100% sensitive and specific PCR test is
available (e.g., via repeated PCR testing).


## Symptomatic Isolation (default)

The current default policy (after reopening of schools) is to rely on symptomatic
isolation of any pupil with symptoms.
The symptomatic pupil goes in isolation directly and is PCR tested.
We assume a turnaround of 2 days for the PCR test. 
Once the test result becomes available, the pupil either returns (negative)
or stays in isolation for another 8 days (total of 10) and all other
members of the same bubble also isolate for 8 days (positive).


## Extended Weekend

An alternative to prolonged lockdowns is the extension of the weekend.
Since the incubation time under the Larremore model is at least three days,
we combine the current default policy with school-free Thursdays and Fridays.


## Regular Screening

Initially, the LFD tests were envisioned to screen the entire population
regularly.
Due to concerns about compliance and testing burden on small children, 
a once-weekly scheme seems much more realistic than a daily scheme.
We consider a testing scheme where each pupil is screened with an LFD test
every Monday (unless they are isolating).
Positive LFD tests or symptomatic cases are followed up with a PCR test to
determine the length of isolation as usual.
No preemptive bubble isolation is implemented.



## 'Test & Release' Approach

Instead of sending an entire bubble into PCR testing and isolation based on 
mere (not necessarily Covid-19 related) symptoms,
a screening-test-based dynamic testing regime has been discussed.
Here, upon reporting of symptoms, the index case is immediately isolated and 
followed up with a PCR test but the bubble is not immediately co-isolated/PCR-tested.
Instead, a less sensitive but quicker screening test is used on a daily basis
(including the symptom onset day) for every member of the bubble.
Only if a screening test is positive (or someone else develops symptoms)
the person is isolated and followed up with a PCR test.
Again assuming a turnaround of 2 days for the PCR test, the follow up period of
a bubble is a minimum of two days (i.e., until the PCR test comes back negatively)
or 7 days if the index PCR test is positive.



# Population Model for School

We consider a typical UK primary school with two tracks of classes for all 
six grades (a total of 12 classes).
We further assume that each class can be split in three bubbles (overall 36 bubbles) 
and that risk-contacts among pupils who do not belong to the same bubble can be reduced
greatly.
Finally, we assume that each bubble consists of eight pupils bringing the
total number of pupils to $7\cdot 3\cdot 12=252$.

On each of the three levels (bubble/class/school) member of the same group 
have a certain chance of a daily risk-contact ('meeting probability'). 
After applying the respective test and isolation policies for all groups,
risk contacts on all levels are independently sampled.
For each risk-contact, the corresponding infection probability is used to 
determine (again by random sampling) weather or not a transmission occurs.

We do not model staff explicitly.

We assume a daily meeting probability of $1/251$ on the school level,
of $0.33$ on the class level, and of $0.9$ on the bubble level.
We further assume a daily chance of non-Covid related symptoms of $0.01$ per
individual. 
Further, we assume that every individual is at risk of an external infection 
with a probability of $1/7/252$, i.e., there is roughly one new external
infection per week on average.

```{julia define-population, results="hide"}
@everywhere begin 

lfd = LogGLMTest("lfd", 1e5, 1.0, .5, -9.0, .997)

tbl_policies = DataFrame(
	name = ["default", "extended weekend", "regular screening", "test & release", "50:50 split"],
	policy = [
		SymptomaticIsolation(pcr_turnaround = 2, isolation_duration = 2),
		SymptomaticIsolation(pcr_turnaround = 2, isolation_duration = 2, isolation_weekdays = [3,4]),
		RegularScreening(lfd; isolate_all = false, test_weekdays = [0], pcr_turnaround = 2, isolation_duration = 8),
		DynamicScreening(lfd,
			pcr_turnaround = 2,
			isolation_duration = 8,
	    	followup_duration = 7,
			followup_weekdays = collect(0:4)
		),
		SplitGroup(a_days = [0, 2], b_days = [1, 3]; pcr_turnaround = 2, isolation_duration = 8)
	]
)

end # @everywhere
```

```{r plot-adjacency-matrix}
A <- julia_eval("get_adjacency_matrix(sample_school(.033, DoNothing(), .01, .5))")
plt <- ggraph(as_tbl_graph(A), "matrix") +
	geom_edge_tile(aes(fill = weight)) + 
	scale_edge_fill_continuous(
		"", 
		low = "#dddddd", high = "#000000", na.value = "white",
		limits = c(0, NA_real_)
	) +
	coord_fixed(expand = FALSE) +
	theme(
		legend.position = "right"
	) +
	labs(
		caption = "Adjacency matrix of school population;\r\nconnection strength is 'expected pairwise daily risk contacts' (across all shared groups)."
	)
save_plot(plt, "adjacency-matrix")
print(plt)
```



# Calibrating Infectivity

The Larremore disease model [@larremore2020a] critically depends on the
choice of the infectivity constant $\gamma$.
We fit a calibration curve for $\gamma$ by simulating $r_0$ for a range of
infectivity values.
To that end a single index case is externally infected at day $0$ and the
population is simulated for 21 days without any intervention.
A the conditional mean of a zero-inflated negative binomial regression can then 
be used to obtain $\gamma$ as function of the desired $r_0$.

```{julia generate-calibration-data, results="hide"}
@everywhere begin

function f(gamma)
    school = sample_school(
    	gamma, 
    	DoNothing(), 
    	.01,
    	.5
    )
    infect!.(school.individuals[1])
    steps!(school, 21)
    res = get_contact_log(school.individuals[1])
    res[!, :gamma] .= gamma
    res
end

end # @everywhere

tbl_r0 = DataFrame(
		gamma = collect(range(0, 0.075, length = 1000))
	)
tbl_tmp = vcat(pmap(f, tbl_r0[!, :gamma])...)
tbl_r0 = leftjoin(tbl_r0, tbl_tmp; on = :gamma)
```

```{r get-calibration-data}
tbl_r0 <- as_tibble(julia_eval("tbl_r0"))
```

```{r plot-calibration-data}
tbl_r0 <- tbl_r0 %>%
	group_by(gamma, uuid_a) %>%
	summarize(r0 = sum(infected_other), .groups = "drop")

fit <- zeroinfl(
	formula = r0 ~ gamma | gamma, 
	dist = "negbin", 
	data = tbl_r0
)

plt <- ggplot(tbl_r0) +
	aes(gamma, r0) +
	geom_point(alpha = 0.2, shape = 16) +
	geom_line(
		data = tibble(
			gamma = seq(0, .075, length.out = 100),
			r0 = as.numeric(predict(fit, newdata = tibble(gamma = gamma), type = "response"))
		)
	) +
	labs(
		x = expression(gamma),
		caption = "Fitted zero-inflated negative binomial regression for r-zero vs. infectivity."
	)
save_plot(plt, "calibrating-infectivity")
print(plt)
```

An $r_0$ of less than $1$ in a school environment under only symptomatic self
isolation is highly unlikely and thus considered the best-case-scenario.
We then investigate the impact of different r zero values up to $r_0=5$.

```{r define-calibration-function}
infectivity <- function(r0) {
	f <- function(gamma) as.numeric(predict(fit, newdata = tibble(gamma = gamma), type = "response"))
	as.numeric(uniroot(function(x) f(x) - r0, interval = c(0, .1))$root)
}
```

```{r define-scenarios}
tbl_scenarios <- tibble(
		r0 = c(1.5, 2, 3, 5),
		gamma = purrr::map_dbl(r0, infectivity),
		pr_noncovid_symptoms = 0.01,
		frac_symptomatic = 0.5,
		pr_external_infections = 1/12/27/7 # expected 1 per week
	) %>%
	expand_grid(
		iter = 1:100,
		name = c("default", "extended weekend", "regular screening", "test & release") #, "50:50 split")
	)
julia_assign("tbl_scenarios", as.data.frame(tbl_scenarios))
```



# Evaluating Performance

When comparing policies, it is important to look at all relevant key performance
indicators.
In a school context, the number of infections is secondary since almost all
disease courses are very mild.
The number of *infectious* pupils might, however, be of interest as an indicator
for the risk posed to the wider community.
Furthermore, the number of schooldays missed, the number of (PCR) tests required,
and the average daily number of contacts might all be of interest as well.



# Results

```{julia run-simulation, results="hide"}
# join with actual policy definitions
tbl_scenarios = leftjoin(tbl_scenarios, tbl_policies, on = :name)

@everywhere function evaluate_school(
	gamma, 
	policy, 
	pr_noncovid_symptoms, 
	frac_symptomatic, 
	pr_external_infections
)
	school = sample_school(gamma, policy, pr_noncovid_symptoms, frac_symptomatic)
	for i in 1:(12*7)
		for indv in school.individuals
			if rand(Bernoulli(pr_external_infections))
				infect!(indv)
			end
		end
    	step!(school)
    end
    evaluate(school)
end

tbl_results = hcat(
	tbl_scenarios,
	vcat(pmap(
		evaluate_school,
		tbl_scenarios[!, :gamma],
		tbl_scenarios[!, :policy],
		tbl_scenarios[!, :pr_noncovid_symptoms],
		tbl_scenarios[!, :frac_symptomatic],
		tbl_scenarios[!, :pr_external_infections]
	)...)
)
# deselect complex columns, don't need ID
select!(tbl_results, Not([:policy, :id]))
```

```{r retrieve-simulation-results}
tbl_results <- as_tibble(julia_eval("tbl_results"))
```

```{r plot-simulation-results}
plt <- tbl_results %>%
	select(-mean_daily_pp_contacts, -std_daily_infectious, 
		   -pr_external_infections, -pr_noncovid_symptoms, -frac_symptomatic) %>%
	rename(
		`mean infectious pupils (daily)` = mean_daily_infectious,
		`infected pupils (cumulative)` = n_infected,
		`required PCR tests (cumulative)` = n_pcr_tests,
		`schooldays missed (cumulative)` = workdays_missed
	) %>%
	pivot_longer(-c(r0, gamma, iter, name), names_to = "quantity") %>%
	ggplot() +
		geom_boxplot(
			aes(x = factor(r0), color = name, y = value),
			outlier.shape = NA
		) +
		facet_wrap(
			~quantity,
			scales = "free",
			nrow = 2
		) +
		labs(
			x = "r zero",
			y = "",
			caption = "Boxplots of the performance distribution (100 resamples) per r-zero and policy; outliers not plotted."
		)
save_plot(plt, "results")
print(plt)
```


# References
