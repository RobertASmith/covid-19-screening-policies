---
title: "Is 'Test & Release' Viable to Reopen Schools?"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

knitr::opts_chunk$set(
	# cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

theme_set(
	theme_bw() + 
	theme(
		legend.position = "top",
		panel.grid.minor = element_blank(),
		legend.title = element_blank()
	)
)
```

```{julia julia-setup, include=FALSE}
using Distributed, Pkg
Pkg.activate(".julia")
using cov19sim
addprocs(Sys.CPU_THREADS)
@everywhere begin 
	using Pkg
	Pkg.activate(".julia")
	using cov19sim, DataFrames
end
```



# Problem Statement

The ongoing Covid-19 pandemic in the United Kingdom made nationwide lockdowns
of schools a reality in late 2020 and early 2021.
Such drastic policies are particularly burdensome for families with young
children who cannot effectively attend remote schooling.
The availability of cheap screening tests opens the opportunity of a more
nuanced approach to reopening at least nurseries and primary schools.
However, the impact of the various screening and isolation policies on key
performance indivators is not well understood.



# Policies 

For all policies, we assume that a 100% sensitive and specific PCR test is
available (e.g., via repeated PCR testing).


## Current Government Policy

The current default policy (after reopening of schools) is to rely on symptomatic
isolation of any pupil with symptoms and the corresponding bubble.
We assume that all isolated individuals are followed-up with a PCR test and
that the isolation period is determined by the outcome of the PCR test.
If it is positive, the pupil can return to school, if it is negative the 
pupil has to isolate for 14 additional days post-result. 
Assuming an average turnaround of 2 days for the PCR test this means that
negative individuals have to isolate on the day of the index event and the 
following day while PCR positive individuals have to isolate for a total of 
14 days.


## 'Test & Release' Approach

Instead of sending an entire bubble into PCR testing and isolation based on 
mere (not necessarily Covid-19 related) symptoms,
a screening-test-based dynamic testing regime has been discussed.
Here, upon reporting of symptoms, the index case is immediately isolated and 
followed up with a PCR test but the bubble is not immediately co-isolated/PCR-tested.
Instead, a less sensitive but quicker screening test is used on a daily basis
(including the symptom onset day) for every member of the bubble.
Only if a screening test is positive (or someone else develops symptoms)
the person is isolated and followed up with a PCR test.
Again assuming a turnaround of 2 days for the PCR test, the follow up period of
a bubble is a minimum of two days (i.e., until the PCR test comes back negatively)
or 7 days if the index PCR test is positive.



# Population Model for School

We consider a typical UK primary school with two tracks of classes for all 
six grades (a total of 12 classes).
We further assume that each class can be split in three bubbles (overall 36 bubbles) 
and that risk-contacts among pupils who do not belong to the same bubble can be reduced
greatly.
Finally, we assume that each bubble consists of eight pupils bringing the
total number of pupils to $7\cdot 3\cdot 12=252$.

On each of the three levels (bubble/class/school) member of the same group 
have a certain chance of a daily risk-contact ('meeting probability'). 
After applying the respective test and isolation policies for all groups,
risk contacts on all levels are independently sampled.
For each risk-contact, the corresponding infection probability is used to 
determine (again by random sampling) weather or not a transmission occurs.

We do not model staff explicitly.

We assume a daily meeting probability of $1/251$ on the school level,
of $0.33$ on the class level, and of $0.9$ on the bubble level.
We further assume a daily chance of non-Covid related symptoms of $0.01$ per
individual. 

```{julia define-population}
@everywhere begin 

function sample_school(gamma, schooldays, policy)
	dm = LarremoreModel(
		gamma;
	    frac_symptomatic = 0.5,
    	l10vl_onset = 3.0, day_onset_min = 2.5, day_onset_max = 3.5,
    	l10vl_peak_min = 7.0, l10vl_peak_max = 11.0, peak_delay_max = 3.0, peak_delay_shape = 1.5,
		symptom_delay_min = 0.0, symptom_delay_max = 3.0,
    	l10vl_clearance = 6.0, clearance_delay_min = 4.0, clearance_delay_max = 9.0
	)
    ThreeLevelPopulation(
    	n_per_bubble = 7,
	    bubbles_per_class = 3,
	    m_classes = 12,
	    pr_meet_bubble = 0.9,
	    pr_meet_class = 0.33,
	    pr_meet_school = 1/251,
	    policy_bubble = DoNothing(),
	    policy_class = DoNothing(),
	    policy_school = policy,
	    meeting_days = schooldays,
	    disease_model = dm,
	    pr_unrelated_symptoms = 0.01
    )
end

lfd_test = LogPropTest(
	"lfd", 
	5.0, # log-10 VL LOD 
	1/12, # log-10 excess VL proportionality constant for sensitivity
	.997 # specificity
)


tbl_policies = DataFrame(
	name = ["default", "extended weekend"], #, "test & release"],
	schooldays = [collect(0:4), collect(0:1)], #, collect(0:4)],
	policy = [
		SymptomaticIsolation(14, true),
		SymptomaticIsolation(14, true)
	# 	DynamicScreening(lfd_test, 
	# 		pcr_turnaround = 2, 
	# 		isolation_duration = 14, 
	#     	followup_duration = 7, 
	# 		followup_weekdays = collect(0:4)
	# 	)
	]
)

end # @everywhere

show(tbl_policies)
```



# Calibrating Infectivity

The Larremore disease model [@larremore2020a] critically depends on the 
choice of the infectivity constant $\gamma$.
We fit a calibration curve for $\gamma$ by simulating $r_0$ for a range of 
infectivity values.
A Poisson regression can then be used to obtain $\gamma$ as function of the
desired $r_0$.

```{julia, results="hide"}
@everywhere begin 

function f(gamma)
    school = sample_school(
    	gamma, tbl_policies[1, :schooldays], tbl_policies[1, :policy]
    )
    infect!.(school.individuals[1])
    steps!(school, 21)
    res = get_contact_log(school.individuals[1])
    res[!, :gamma] .= gamma
    res
end

end # @everywhere

tbl_r0 = DataFrame(
		gamma = collect(range(0, 0.15, length = 1000))
	)
tbl_tmp = vcat(pmap(f, tbl_r0[!, :gamma])...)
tbl_r0 = leftjoin(tbl_r0, tbl_tmp; on = :gamma)
```

```{r}
tbl_r0 <- as_tibble(julia_eval("tbl_r0"))
```

```{r}
tbl_r0 <- tbl_r0 %>%
	group_by(gamma, uuid_a) %>% 
	summarize(r0 = sum(infected_other), .groups = "drop")

ggplot(tbl_r0) +
	aes(gamma, r0) +
	geom_point() +
	geom_smooth(method = "glm", formula = y ~ x, method.args = list(family = "poisson"))
```

An $r_0$ of less than $1$ in a school environment under only symptomatic self
isolation is highly unlikely.
We thus consider the following three scenarios:

1. $r_0=1.0$: best-case scenario.
2. $r_0=1.25$: reasonably slow spread.
3. $r_0=2$: fast spread.
4. $r_0=5$: very fast spread.

```{r}
fit <- glm(r0 ~ gamma, family = "poisson", data = tbl_r0)
infectivity <- function(r0) {
	f <- function(gamma) as.numeric(predict(fit, newdata = tibble(gamma = gamma), type = "response"))
	as.numeric(uniroot(function(x) f(x) - r0, interval = c(0, .15))$root)
}
```

```{r define-scenarios}
tbl_scenarios <- tibble(
		r0 = c(1.5, 2, 5),
		gamma = purrr::map_dbl(r0, infectivity)
	) %>%
	expand_grid(
		iter = 1:50,
		name = c("default", "extended weekend") #, "test & release")
	)
julia_assign("tbl_scenarios", as.data.frame(tbl_scenarios))
tbl_scenarios %>%
	group_by(r0, name) %>%
	summarize(
		resamples = n(),
		.groups = "drop"
	) %>%
	knitr::kable(caption = "Considered infectivity scenarios.")
```



# Evaluating Performance

When comparing policies, it is important to look at all relevant key performance
indicators.
In a school-context, the number of infections is secondary since almost all
disease courses are very mild.
The number of infectious pupils might, however, be of interest as an indicator
for the risk posed to the wider community.
Furthermore, the fraction of schooldays missed, the number of (PCR) tests required,
and the average daily number of contacts might all be of interest.



# Results

```{julia run-simulation, results="hide"}
# join with actual policy definitions
tbl_scenarios = leftjoin(tbl_scenarios, tbl_policies, on = :name)

@everywhere function evaluate_school(gamma, schooldays, policy)
	school = sample_school(gamma, schooldays, policy)
	infect!.(school.individuals[1])
    steps!(school, 12*7)
    evaluate(school)
end

tbl_results = hcat(
	tbl_scenarios,
	vcat(pmap(
		evaluate_school,
		tbl_scenarios[!, :gamma],
		tbl_scenarios[!, :schooldays],
		tbl_scenarios[!, :policy]
	)...)
)
# deselect complex columns, don't need ID
select!(tbl_results, Not([:policy, :schooldays, :id]))
```

```{r retrieve-simulation-results}
tbl_results <- as_tibble(julia_eval("tbl_results"))
```

```{r plot-simulation-results, fig.height=10}
tbl_results %>%
	pivot_longer(-c(r0, gamma, iter, name), names_to = "quantity") %>%
	ggplot() +
		geom_boxplot(
			aes(x = factor(r0), color = name, y = value), 
			outlier.shape = NA
		) +
		facet_wrap(
			~quantity,
			scales = "free",
			# labeller = labeller(function(r0) sprintf("r-zero: %s", r0))
		) +
		labs(x = "r zero", y = "")
```


# References
