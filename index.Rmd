---
title: "Policy Evaluation for Reopening of Schools"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document:
        toc: true
        toc_float: true
bibliography: references.bib
params:
    iterations: 50
---

```{r r-setup, include=FALSE, cache=FALSE}
library(JuliaCall)
library(tidyverse)
library(tidygraph)
library(ggraph)
library(patchwork)
library(pscl)

source("code/util.R")

width <- 8
height <- width/1.61

knitr::opts_chunk$set(
	# cache = TRUE,
	echo = FALSE,
	fig.width = width,
	fig.height = height
)

JuliaCall::julia_setup(force = TRUE)
JuliaCall::julia_source("code/setup.jl")
```



# Problem Statement

The ongoing Covid-19 pandemic in the United Kingdom made nationwide lockdowns
of schools a reality in late 2020 and early 2021.
Such drastic policies are particularly burdensome for families with young
children who cannot effectively attend remote schooling.
The availability of cheap screening tests opens the opportunity of a more
nuanced approach to reopening at least nurseries and primary schools.
However, the impact of the various screening and isolation policies on key
performance indicators is not well understood.



# The Model {.tabset}


## School Structure

We consider a typical UK primary school with two tracks of classes for all 
six grades (a total of 12 classes).
We further assume that each class can be split in three bubbles 
(overall 36 bubbles)  and that risk-contacts among pupils who do not belong to 
the same bubble can be reduced greatly.
Finally, we assume that each bubble consists of nine pupils bringing the
total number of pupils to $9\cdot 3\cdot 12=324$.

On each of the three levels (bubble/class/school) member of the same group 
have a defined chance of a daily risk-contact ('meeting probability'). 
After applying the respective test and isolation policies for all groups,
risk contacts on all levels are sampled independently.
For each risk-contact, the corresponding infection probability is used to 
determine (again by random sampling) weather or not a transmission occurs.

We do not model staff explicitly.

We assume a daily meeting probability of $1/(324 - 1)$ on the school level,
of $3/(27 - 1)$ on the class level, and of $1.0$ on the bubble level.
We further assume a daily chance of non-Covid related symptoms of $0.01$ per
individual. 
Further, we assume that every individual is at risk of an external infection 
with a probability of $1/7/324$, i.e., there is roughly one new external
infection per week on average.

```{r plot-school-structure}
          n_bubble <- 9
 bubbles_per_class <- 3
classes_per_school <- 12

 n_class <- n_bubble * bubbles_per_class
n_school <- classes_per_school * n_class

pr_meet_class <- 3/(n_class - 1)
pr_meet_school <- 1/(n_school - 1)

plt <- julia_call("school", 
		n_bubble, bubbles_per_class, classes_per_school, pr_meet_class, pr_meet_school, 
		0.0, # gamma
		0.5, # frac symptomatic
		0.01 # pr_noncov_symptoms
	) %>% 
	julia_call("get_adjacency_matrix", .) %>% 
	as_tbl_graph() %>% 
	ggraph("matrix") +
		geom_edge_tile(aes(fill = weight)) + 
		scale_edge_fill_continuous(
			"", 
			low = "#dddddd", high = "#000000", na.value = "white",
			limits = c(0, NA_real_)
		) +
		coord_fixed(expand = FALSE) +
		theme(
			legend.position = "right"
		) +
		labs(
			caption = "Adjacency matrix of school population;\r\nconnection strength is 'expected pairwise daily risk contacts' (across all shared groups)."
		)
save_plot(plt, "adjacency-matrix", width = 2*width/3, height = 2*height/3)
print(plt)
```


## Calibrating Infectivity

We use the joint model for viral load (VL) and symptom onset proposed by
Larremore and colleagues.
The Larremore disease model critically depends on the
choice of the infectivity constant ($\gamma$) for the proportionality 
[@larremore2020a].
We fit a calibration curve for $\gamma$ by simulating $R_0$ for a range of
infectivity values assuming a fraction of symptomatic individuals of 50%.
To that end, a single index case is externally infected at day $0$ and the
population is simulated for 21 days without any intervention.
A the conditional mean of a zero-inflated negative binomial regression can then 
be used to obtain $\gamma$ as function of the desired $R_0$.

```{r calibrate-infectivity}
tbl_r_zero <- tibble(
	gamma = seq(0, 0.1, length.out = 1000),
	R = julia_call("simulate_r_zero.", 
		julia_call("school.", 
			n_bubble, bubbles_per_class, classes_per_school, pr_meet_class, pr_meet_school, 
			gamma,
			0.5, # frac symptomatic
			0.01 # pr_noncov_symptoms
		)
	)
)

fit <- zeroinfl(formula = R ~ gamma | gamma, dist = "negbin", data = tbl_r_zero)

# define inverse function
get_gamma <- function(R) {
	f <- function(gamma) as.numeric(predict(fit, newdata = tibble(gamma = gamma), type = "response"))
	as.numeric(uniroot(function(x) f(x) - R, interval = c(0, .1))$root)
}

plt <- ggplot(tbl_r_zero) +
	aes(gamma, R) +
	geom_point(alpha = 0.2, shape = 16) +
	geom_line(
		data = tibble(
			gamma = seq(0, .1, length.out = 100),
			R = as.numeric(predict(fit, newdata = tibble(gamma = gamma), type = "response"))
		)
	) +
	labs(
		x = expression(gamma),
		caption = "Fitted zero-inflated negative binomial regression for r-zero vs. infectivity."
	)
save_plot(plt, "calibrating-infectivity", width = width, height = height/2)
print(plt)
```

A $R_0$ of less than $1.5$ in a school environment is highly unlikely and thus 
considered the best-case-scenario.
We consider $R_0 = 1.5, 3, 6$.


## VL Trajectories

To given an impression of typical trajectories we sample 16 trajectories
using the default parameters and a fraction of 50% asymptomatic cases.

```{r plot-vl-trajectories, warning=FALSE}
dm <- julia_call("LarremoreModel", get_gamma(R = 3), frac_symptomatic = 0.5, need_return = "Julia")
individuals <- julia_call("Individual.", dm, rep(.01, 32), need_return = "Julia")
julia_call("infect!.", individuals, need_return = "Julia")
julia_call("steps!.", individuals, 21L, need_return = "Julia")

plt <- julia_call("get_status_logs", individuals, need_return = "R") %>% 
	as_tibble() %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(day, viral_load) +
	 	geom_hline(yintercept = 1e6) +
		geom_bar(aes(fill = symptomatic), stat = "identity", alpha = .66, width = 1) +
		scale_y_log10() +
		scale_x_continuous("day post infection", breaks = seq(0, 35, by = 7)) +
		scale_fill_manual(breaks = c("non-symptomatic", "symptomatic"), values = c("darkgray", "black")) +
		ylab("viral load") +
		facet_wrap(~uuid, nrow = 4) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank()
		)
save_plot(plt, "vl-trajectories")
print(plt)
```



## Test Sensitivity

We assume a fixed sensitivity of 97.5% over a lower limit of detection of $300 cp/ml$
and a specificity of 100% for PCR tests.

```{r define-pcr-test}
pcr <- julia_call("FixedTest", "pcr", 0.975, 1.0, lod = 300.0, need_return = "Julia")
```

LFD tests are generally much less sensitive.
We fit a logistic curve to data for the Innova LFD shown [here](http://modmedmicro.nsms.ox.ac.uk/wp-content/uploads/2021/01/infectivity_manuscript_20210119_merged.pdf)
by screen-grabbing the curve on page 22 of the PDF.

```{r fit-innova-data}
# screen grabbed pixels
tbl_innova_data <- tibble(
	`viral load` = 10^(2:7),
	sensitivity = 1 - (c(621, 521, 344, 207, 144, 123) - 114) / (684 - 114)
)

sensitivity <- function(vl, slope, intercept) {
	lfd <- julia_call("LogRegTest", "lfd", slope, intercept, 0.998, need_return = "Julia")
	julia_call("sensitivity.", lfd, vl, need_return = "R")
}

innova <- optim(
	c(.76, -5), 
	function(x) {
		sum((
			tbl_innova_data$sensitivity - 
			sensitivity(tbl_innova_data$`viral load`, slope = x[1], intercept = x[2])
		)^2)
	},
	method = "L-BFGS-B",
	lower = c(.1, -10),
	upper = c(2.5, 5),
	control = list(maxit = 1e4)
)
innova$slope <- innova$par[1]
innova$intercept <- innova$par[2]
```

Since we use different studies to calibrate the disease model (Larremore) and
the test sensitivity profile, a plausibility check is in place.
We use a third data source, the [Liverpool community testing report](https://www.liverpool.ac.uk/media/livacuk/coronavirus/Liverpool,Community,Testing,Pilot,Interim,Evaluation.pdf)
to check the plausibility of the fitted sensitivity profile.
The Liverpool pilot found that the test sensitivity of the Innova test in a
practical setting was only 40%.
The study was based on *presymptomatic* individuals.
We can use this information by simulating a population of infected individuals
and randomly pick a pre-symptomatic time-point with a viral load detectable by PCR.
The mean of the corresponding distribution of viral load values should then be
aligned with the Liverpool data.
Since this is not the case, we introduce a scaling factor to reconcile the
shape of the sensitivity curve found in the Oxford data with the mean sensitivity
of the real-world experiement from Liverpool, i.e., we consider 'scaled sensitivity'

\begin{align}
\operatorname{sensitivity}'(\operatorname{VL}) :&= 
	\operatorname{logit}^{-1}\big(
	\beta_{\operatorname{VL}} \cdot \log_{10}\big( \operatorname{VL}^\eta \big)
	+ c_{\operatorname{test}}
\big)
\end{align}

For a sample of $100,000$ under the Larremore et al. model with 50% symptomatic
cases the mean of the scaled sensitivity as function of $\eta$ is given below.

```{r recalibrate-innova-lfd-test}
dm <- julia_call("LarremoreModel", get_gamma(R = 3), frac_symptomatic = 0.5, need_return = "Julia")
individuals <- julia_call("Individual.", dm, rep(.01, 1e5), need_return = "Julia")
julia_call("infect!.", individuals, need_return = "Julia")
julia_call("steps!.", individuals, 21L, need_return = "Julia")

tbl_vl <- julia_call("get_status_logs", individuals) %>% 
	as_tibble() %>% 
	arrange(uuid, day) %>%
	group_by(uuid) %>%
	filter(
		row_number() >= which(viral_load > 300)[1],
		row_number() < which(symptomatic)[1]
	) %>%
	sample_n(1) %>%
	ungroup() %>%
	select(uuid, day, viral_load)

mean_sensitivity <- function(eta) {
	tbl_vl %>%
		mutate(
			sensitivity = sensitivity(viral_load^eta, slope = innova$slope, intercept = innova$intercept)
		) %>%
		pull(sensitivity) %>%
		summary() %>%
		mean()
}

# define inverse
get_eta <- function(sens) uniroot(function(x) mean_sensitivity(x) - sens, interval = c(0, 5))$root

tbl_scenarios <- tibble(
		`mean sensitivity` = c(mean_sensitivity(1), .4, .6, .8),
		eta = map_dbl(`mean sensitivity`, get_eta)
	)

plt <- tbl_scenarios %>% 
	expand_grid(
		`viral load` = 10^seq(0, 11, length.out = 1000),
	) %>% 
	mutate(
		sensitivity = sensitivity(`viral load`^eta, slope = innova$slope, intercept = innova$intercept)
	) %>%
	ggplot() +
		aes(`viral load`, sensitivity) +
		geom_line(aes(linetype = sprintf("%.2f", `mean sensitivity`))) +
		geom_point(data = tbl_innova_data) +
		scale_x_log10() +
		scale_y_continuous("", limits = c(0, 1)) +
		scale_linetype_manual("", 
			breaks = sprintf("%.2f", tbl_scenarios$`mean sensitivity`), 
			values = c(1, 4, 3, 2),
			labels = purrr::map2(
				sprintf("%.2f", tbl_scenarios$`mean sensitivity`),
				tbl_scenarios$eta,
				~bquote( .(..1) (eta == .(round(..2, 2))) )
			)
		) +
		labs(
			caption = "Fitted Innova LFD test sensitivity."
		) +
		theme(
			legend.position = "right"
		)
save_plot(plt, "fit-sensitivity", width = width, height = height/2)
print(plt)
```


## Autocorrelation

...




## Sensitivity & Infectivity

```{r plot-sensitivity-vs-infection-probability}
plt <- expand_grid(
		tibble(
			`mean sensitivity` = c(.4, .6, .8),
			eta = map_dbl(`mean sensitivity`, get_eta)
		),
		tibble(
			R = c(1.5, 3, 6),
			gamma = map_dbl(R, get_gamma)
		)
	) %>% 
	expand_grid(
		`viral load` = 10^seq(0, 11, length.out = 1000)
	) %>% 
	mutate(
		sensitivity = sensitivity(`viral load`^eta, slope = innova$slope, intercept = innova$intercept),
		`probability to infect` = pmax(0, pmin(1, gamma * (log10(`viral load`) - 6)))
	) %>% 
	ggplot() +
		aes(`probability to infect`) +
		geom_line(aes(y = sensitivity)) +
		facet_grid(
			`mean sensitivity` ~ R, 
			 labeller = label_both
		) +
		ylab("sensitivity")
save_plot(plt, "sensitivity-vs-infectivity", width = width, height = height)
print(plt)
```



# Policies

## Symptomatic Isolation (default)

...

## 'Test & Release' Approach

...




```{r define-scenarios}
tbl_sim_scenarios <- tibble(
		n_bubble = n_bubble,
		bubbles_per_class = bubbles_per_class,
		classes_per_school = classes_per_school,
		pr_meet_class = pr_meet_class,
		pr_meet_school = pr_meet_school,
	) %>% expand_grid(
		tibble(
			R = c(1.5, 3, 6),
			gamma = purrr::map_dbl(R, get_gamma)
		),
		frac_symptomatic = c(0.25, 0.5, 0.75),
		pr_external_infections = 1/(n_school*7), # expected 1 per week
		pr_noncovid_symptoms = .01,
		pcr = list(pcr),
		tibble(
			mean_sensitivity = c(.4, .6, .8),
			eta = purrr::map_dbl(mean_sensitivity, get_eta)
		)
	) %>%
	mutate(
		slope = innova$slope, intercept = innova$intercept, 
		ar_window = 0L, ar_coefficient = 0
	) %>%
	expand_grid(
		policy_name = c("default", "Thu/Fri off", "Mon screening", "Mon/Wed screening", "test & release"),
		iter = 1:(params$iterations)
	)
```

```{r run-simulation}
tbl_results <- bind_cols(
	tbl_sim_scenarios,
	with(tbl_sim_scenarios,
		julia_call("evaluate_performance",
			n_bubble, bubbles_per_class, classes_per_school, pr_meet_class, pr_meet_school,
			gamma, frac_symptomatic, pr_external_infections, pr_noncovid_symptoms,
			pcr,
			eta, slope, intercept, ar_window, ar_coefficient,
			policy_name,
			need_return = "R"
		)
	)
) %>% 
rename(
	`mean sensitivity` = mean_sensitivity
) %>% 
mutate(
	mean_weekly_infections = round(pr_external_infections*n_school*7, 2)
)
readr::write_rds(tbl_results, "tbl_results.rds", compress = "gz")
```



# Evaluating Performance

In a school context, the number of infections is secondary since almost all
disease courses are very mild.
The number of *infectious* pupils might, however, be of interest as an indicator
for the risk posed to the wider community.
Furthermore, the number of schooldays missed, the number of (PCR) tests required,
and the average daily number of contacts might all be of interest as well.



# Results {.tabset}

## Infections & infectivtiy

The mean daily number of infectious pupils is close to proportional to the
cumulative number of infections and the proportionality constant are negligible 
between policies.

```{r}
plt <- tbl_results %>%
	filter(
		frac_symptomatic == 0.5,
		mean_weekly_infections == 1
	) %>%
	ggplot() +
		aes(n_infected/n_school, mean_daily_infectious) +
		geom_vline(xintercept = 6/n_school) +
		geom_point(aes(color = policy_name), alpha = 0.5, shape = 16) +
		geom_smooth(
			aes(color = policy_name), method = "lm", se = FALSE,
			formula = y ~ x, size = 0.5
		) +
		scale_y_continuous("mean infectious (daily)") +
		scale_x_continuous("% infected (cumulative)", labels = scales::percent) +
		facet_grid(`mean sensitivity` ~ R, labeller = label_both, scales = "free_x")
save_plot(plt, "infectiousness-vs-infectivity", width = width, height = 1.5*height)
print(plt)
```

We thus use the two terms interchangeably and focus on the marginal distribution
the cumulative number of infections.

```{r}
plt <- tbl_results %>%
	filter(
		frac_symptomatic == 0.5,
		mean_weekly_infections == 1
	) %>%
	ggplot() +
		aes(policy_name, n_infected/324) +
		geom_hline(yintercept = 6/324, color = "red") +
		geom_boxplot() +
		scale_y_continuous("% infected (cumulative)", labels = scales::percent) +
		facet_grid(`mean sensitivity` ~ R, labeller = label_both) +
		theme(
			axis.text.x = element_text(angle = 45, hjust = 1),
			axis.title.x = element_blank()
		)
save_plot(plt, "infectivity", width = width, height = 1.5*height)
print(plt)
```


## PCR Tests Required

```{r}
plt <- tbl_results %>%
	filter(
		frac_symptomatic == 0.5,
		mean_weekly_infections == 1
	) %>%
	ggplot() +
		aes(n_infected/324, n_pcr_tests) +
		geom_vline(xintercept = 6/324) +
		geom_point(aes(color = policy_name), alpha = 0.5, shape = 16) +
		geom_smooth(
			aes(color = policy_name), method = "lm", se = FALSE,
			formula = y ~ x, size = 0.5
		) +
		scale_y_continuous("PCR test required (cumulative)") +
		scale_x_continuous("% infected (cumulative)", labels = scales::percent) +
		facet_grid(`mean sensitivity` ~ R, labeller = label_both, scales = "free_x")
save_plot(plt, "pcr-vs-infectivity", width = width, height = 1.5*height)
print(plt)
```


## Schooldays Missed

```{r}
plt <- tbl_results %>%
	filter(
		frac_symptomatic == 0.5,
		mean_weekly_infections == 1
	) %>%
	ggplot() +
		aes(n_infected/324, workdays_missed/324/5/6) +
		geom_vline(xintercept = 6/324) +
		geom_point(aes(color = policy_name), alpha = 0.5, shape = 16) +
		geom_smooth(
			aes(color = policy_name), method = "lm", se = FALSE,
			formula = y ~ x, size = 0.5
		) +
		scale_x_continuous("% infected (cumulative)", labels = scales::percent) +
		scale_y_continuous(labels = scales::percent) +
		facet_grid(`mean sensitivity` ~ R, labeller = label_both, scales = "free_x") +
		labs(
			y = "% schooldays missed (cumulative)"
		)
save_plot(plt, "schooldays-missed-vs-infectivity", width = width, height = 1.5*height)
print(plt)
```



# References
