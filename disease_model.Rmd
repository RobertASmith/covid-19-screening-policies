---
title: "The Covid-19 Disease Model by Larremore et al."
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

source("code/util.R")

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

set.seed(42)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
using cov19sim
import Random.seed!
seed!(42)
```



# Problem Statement

This document briefly presents the disease and infection model for SARS-CoV-2
used by Larremore and colleagues [@larremore2020a].
The model is centered around an individual's viral load 
(VL, measured in copies per milliliter $cp/ml$) trajectory over time.
For references justifying the choice of individual parameters, 
please refer to the original publication.



# Viral Load Model

Each individual's VL trajectory is determined via a set of pivot points.
The ordinate of the pivot points used in the Larremore-model are given on the 
log-10 VL scale. 
At any point in time, an individual's log-10 VL-trajectory is determined by 
linear interpolation of the pivot points.

The pivot points are:

1. **Start of fast exponential growth phase:** $(t_1, 1e3)$ 
2. **Peak log-10 VL:** $\big(t_2, \log_{10}(\operatorname{VL}_{peak})\big)$
3. **Clearance point (point of non-infectiousness):** $(t_3, 1e6)$

To sample a full VL-trajectory, it is first determined whether the trajectory
will ultimately become symptomatic by sampling from a Bernoulli distribution with
a probability $\rho_{sympt.}$ for becoming symptomatic.

The first pivot timing $t_1$ is sampled uniformly between $2.5$ and $3.5$ days
after the infection time $t=0$.

The second pivot points delay with respect to $t_1$ is sampled as
$t_2 - t_1 = 0.5 + \min(3, X)$ where $X\sim \operatorname{Gamma}(1.5)$.
The corresponding ordinate, peak log-10 VL  $\log_{10}(\operatorname{VL}_{peak})$, 
is sampled uniformly between $[7, 11]$.

The timing of the third pivot $t_3$, the clearance point of non-infectiousness, 
is sampled conditional on whether or not an individual is symptomatic.
Log-10 VL at clearance (= non-infectiousness) is defined as $1e6$ 
in accordance with the literature cited in [@larremore2020a].
For asymptomatic cases, $t_3 - t_2\sim\operatorname{Unif}(4, 9)$. 
For symptomatic cases, a symptom onset time with delay 
$t_{symptoms}-t_2\sim \operatorname{Unif}(0, 3)$ 
is sampled to determine the time to symptom onset and this symptom onset delay 
is added to $t_3$.
This implies that symptomatic cases have a slower clearance of their peak VL
but the same peak VL.

Although not noted in [@larremore2020a] we set the initial log-10 VL to $0$ at 
$t=0$ and extrapolate linearly after $t_3$ until the log-10 VL reaches 0 again.
Outside of this interval, the log-10 VL is $-\infty$, i.e., VL is $0$.

We then modify the above model slightly to fit it into a simulation framework
with discrete daily time scale. 
We additionally sample an 'infection time' $t_0\sim\operatorname{Unif}(-16.5/24, 7.5/24)$
and add it to $t_1$.
This models the fact that the infection is occurring anywhere from 07:30AM 
on the preceding day to 07:30AM of the current day 
(test & isolation / meetings are assumed to take place at 07:30AM).


# Infection Submodel

The probability that an individual infects a susceptible other individual during
an encounter is modeled as function of the individuals VL.
We assume that individuals who already went though an infection are no longer
susceptible (short term immunity).
In [@larremore2020a], different functional forms for the relationship between VL
and the probability to infect are considered but the main results refer to a 
model where the infectivity is modeled as proportional to the excess 
log-10 VL over the infectivity threshold of $1e6$ 
(Larremore et al. use $\log_{10}(\operatorname{VL}) - 6 \neq \log_{10}(\operatorname{VL} - 1e6)$
although the latter seems to be closer to their verbal description).
Confining this to the valid interval $[0,1]$ yields
$$
\operatorname{Pr}\big[\text{A infect B at $t$} \,|\, \text{B susceptible at $t$} \big] = \max\big(0, \min\big(1, \quad \gamma \cdot \big(\log_{10}\big(\operatorname{VL}_A(t)\big) - 6\big)\quad \big)\big)
$$
where $\gamma$ is the infectivity constant and only free parameter of the 
infection submodel.
Within a population model, the infectivity can then be calibrated, e.g.,
using the reproduction number 
(see article 'Comparing Test and Isolation Policies for Schools under a Larremore et al. Disease Model').


# Example Trajectories

We sample 16 example VL-trajectories.

```{julia sample-trajectories, results="hide"}
dm = LarremoreModel(
    0.75, # fraction symptomatic
    3.0, 2.5, 3.5, # onset height and delay
    7.0, 11.0, 3.0, 1.5, # peak
    0.0, 3.0, # symptoms
    6.0, 4.0, 9.0, # clearance
    .25 # infectivity
)

# create individuals
inds = [Individual(dm, 0.01) for i in 1:16] # .01 chance of non-covid symptoms
# infect them all
infect!.(inds)
# simulate some days forward
steps!.(inds, 45)
tbl_status = get_status_logs(inds)
```

```{r load-tbl-status}
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r plot-vl-trajectories, warning=FALSE, fig.height=7}
plt <- tbl_status %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(day, viral_load) +
	 	geom_hline(yintercept = 1e6) +
		geom_bar(aes(fill = symptomatic), stat = "identity", alpha = .66) +
		scale_y_log10() +
		ylab("viral load") +
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank()
		) + 
		labs(
			caption = "Random sample of VL trajectories with symptom status; black line indicates infectivity threshold."
		)
save_plot(plt, "vl-trajectories")
print(plt)
```

The corresponding trajectories of infection probabilities are given below.
The absolute height of these depends heavily on the infectivity parameter 
$\gamma$ which needs to be calibrated.

```{r plot-infection-probabilities, warning=FALSE, fig.height=7}
plt <- tbl_status %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(day, infection_probability) +
		geom_bar(aes(fill = symptomatic), stat = "identity", alpha = .66) +
		ylab("infection probability") +
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank()
		) + 
		labs(
			caption = "Corresponding infection probabilities per risk-contact; with symptom status."
		)
save_plot(plt, "infection-probability-trajectories")
print(plt)
```


# References
