---
title: "Modeling Test Sensitivity as Function of Viral Load"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

source("util.R")

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

set.seed(42)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
using cov19sim
import Random.seed!
seed!(42)
```



# Problem Statement

This document outlines a simple model for the sensitivity of a screening test
for Covid-19 as function of the latent viral load.



# Test Sensitivity as Function of Viral Load

Concerns about modeling the between-individual heterogeneity of test sensitivity
(see comments by J Deeks to [@kmietowicz2021a]) lead us to a random effects
logistic model for test sensitivity.

$$
\operatorname{sensitivity}(\operatorname{VL}, u) := \operatorname{logit}^{-1}\big( 
	\beta_{\operatorname{eVL}} \cdot \log_{10}( \operatorname{VL} - \operatorname{LOD} ) 
	+ \beta_{u}\cdot u
	+ c
\big) \cdot \boldsymbol{1}_{\,\operatorname{VL}\, \geq\, \operatorname{LOD}}
$$
where $\operatorname{VL}$ is the viral load, $\operatorname{LOD}$ the limit of detection,
$u$ us an individuals latent 'testing random effect' $U\sim\mathcal{N}(0,1)$,
$\beta_{\operatorname{eVL}}, \beta_u$ are the model coefficients, and $c$ is the intercept.
We use log-10 excess viral load in analogy to the infection probability 
model proposed in [@larremore2020a].
The random effects allow a stronger temporal correlation of an individuals 
test results as compared to a model that only relies on the latent viral load
trajectories.



# Example

Looking at a sample of 25 disease trajectories, we can plot sensitivity as
function of viral load for an $\operatorname{LOD}$ of $1e5$ (just below infectivity), 
and $\beta_{e\operatorname{VL}} = 1.0, \beta_u = 0.5, c = -9.0$.
The typical ($U=0$) sensitivity curve is then given by the following plot. 
Sampling a few infected individuals with their respective random effects from
the Larremore disease model yields the following viral load trajectories 
(these are independent of the respective random effect $u$).

```{julia sample, results="hide"}
dm = LarremoreModel(.1)

# create individuals
individuals = [Individual(dm, 0.0) for i in 1:16] # no chance of non-covid symptoms
# infect them all
infect!.(individuals)
lfd = LogGLMTest("lfd", 1e5, 1.0, .5, -9.0, .997)
# simulate some days forward
for i in 1:45
	conduct_test!.(lfd, individuals)
    step!.(individuals)
end
conduct_test!.(lfd, individuals)

tbl_tests = get_test_logs(individuals)
tbl_status = get_status_logs(individuals)
```

```{r extract-results}
u <- julia_eval("[ind.dt.u for ind in individuals]")
tbl_tests <- as_tibble(julia_eval("tbl_tests"))
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r plot-sensitivity}
sens <- function(vl, u) {
	1 / (1 + exp(-(
		log(pmax(0, vl - 1e5), 10) + .5 * u - 9
	))) * if_else(vl >= 1e5, 1, 0)
}

tbl_typical_sensitivity_curve <- tibble(
		u = 0,
		`viral load` = 10^seq(0, 11, length.out = 1000),
		sensitivity = sens(`viral load`, 0)
	)

tbl_individual_sensitivity_curves <- expand_grid(
		u, 
		`viral load` = 10^seq(0, 11, length.out = 1000),
	) %>%
	mutate(
		sensitivity = sens(`viral load`, u)
	)

plt <- ggplot(tbl_individual_sensitivity_curves) +
	aes(`viral load`, sensitivity, group = interaction(u, `viral load` <= 1e5)) +
	geom_line(alpha = .33) +
	geom_line(data = tbl_typical_sensitivity_curve, color = "blue", size = 1.1) +
	geom_vline(xintercept = 1e5) +
	scale_x_log10() + 
	scale_y_continuous("sensitivity", limits = c(0, 1)) +
	labs(
		caption = "'Typical' (u = 0, blue) and sampled individual sensitivity functions; vertical line indicates LOD."
	) +
	theme(
		panel.grid = element_blank()
	)
save_plot(plt, "sensitivity")
print(plt)
```

For each individual, the random effect $u$ slightly shifts the sensitivity curve.
This can easily be seen when joining the sensitivity-viral load points of each 
individual between time points.

If the random effect is reduced to $\beta_{u}=0$ these curves align and reduce
to the 'typical' curve for $u=0$ depicted above.
The addition of the random effect means that the sensitivity curve for each individual
is either consistently lower or higher than the typical curve.
This in turn increases the temporal correlation of subsequent tests within the
same individual.
As a plausibility check, this can be visualized by plotting positive results of
a daily testing regime as vertical bars over the sensitivity trajectories.
The absolute value of the infection probability very much depends on the
chosen infectivity constant $\gamma$ within the Larremore disease model.

```{r plot-test-results}
plt <- tbl_tests %>%
	left_join(
		tbl_status %>%
			select(uuid, day, infection_probability),
		by = c("uuid", "day")
	) %>%
	pivot_longer(c(infection_probability, probability_positive)) %>%
	mutate(
		name = case_when(
				name == "infection_probability" ~ "infection probability",
				name == "probability_positive" ~ "probability of positive test",
			)
	) %>% 
	ggplot() +
		aes(day, value) +
		geom_bar(aes(y = as.numeric(result)), stat = "identity", fill = "gray", position = position_identity()) +
		geom_line(aes(color = name)) + 
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) + 
		labs(
			y = "",
			caption = "Positive test- and and infection probability over time; vertical bars = positive test (under daily testing)."
		)
save_plot(plt, "sensitivity-infectivity-test-results")
print(plt)
```

Yet another way of visualizing the correlation between infectivity and 
test-sensitivity is by plotting each individuals infection and positive-test
probabilities in over time in a state-space diagram.

```{r plot-phase-diagram}
plt <- tbl_tests %>%
	left_join(
		tbl_status %>%
			select(uuid, day, infection_probability),
		by = c("uuid", "day")
	) %>% 
	arrange(uuid, day) %>% 
	ggplot() +
		aes(infection_probability, probability_positive) +
		geom_point(aes(color = uuid)) +
		geom_line(aes(color = uuid), alpha = .33) +
		coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) + 
		labs(
			x = "infection probability",
			y = "probability of positive test result",
			caption = "Scatterplot of positive test- and infection probabilites; color corresponds to individuals."
		) +
		theme(
			legend.position = "none"
		)
save_plot(plt, "sensitivity-vs-infectivity")
print(plt)
```



# References
