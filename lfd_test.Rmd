---
title: "Modeling Test Sensitivity as Function of Viral Load"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

set.seed(42)
theme_set(
	theme_bw() + 
	theme(
		legend.position = "top",
		panel.grid.minor = element_blank(),
		legend.title = element_blank()
	)
)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
using cov19sim
import Random.seed!
seed!(42)
```



# Problem Statement

This document outlines a simple model for the sensitivity of a screening test
for Covid-19 as function of the latent viral load.



# Test Sensitivity as Function of Viral Load

We model the sensitivity as proportional to the excess log-10 viral load, i.e.
$$
\operatorname{sensitivity}(vl) := \Big[\eta\, \big(\log_{10}(vl) - \log_{10}(\operatorname{LOD})\big)\Big]_0^1
$$
where $vl$ is the viral load, $\operatorname{LOD}$ the limit of detection,
$[x]_0^1:=\min(1, \max(0, x))$, and $\eta$ a proportionality constant.
This is analogue to the model for infection probability used in the 
Larremore model [@larremore2020a] and thus introduces a correlation between 
the sensitivity of screening tests and the infectivity of an individual at any given
point in time.
Note that there is no temporal correlation of test results other than via the
dependency on the latent viral load trajectory, i.e., repeated tests are treated
as independent.



# Example

Looking at a sample of 25 disease trajectories, we can plot sensitivity as
function of viral load for an $\operatorname{LOD}$ of $1e5$, and a slope of $\eta=1/12$. 

```{julia, results="hide"}
dm = LarremoreModel(.033)

# create 25 individuals
inds = [Individual(dm, 0.01) for i in 1:25] # .01 chance of non-covid symptoms
# infect them all
infect!.(inds)
# simulate some days forward
steps!.(inds, 45)
tbl_status = get_status_logs(inds)

lfd_test = LogPropTest(
	"lfd", 
	5.0, # log-10 VL LOD 
	1/12, # log-10 excess VL proportionality constant for sensitivity
	.997 # specificity
)

tbl_status.sensitivity = sensitivity.(lfd_test, tbl_status[!, :viral_load])
```

```{r}
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r, warning=FALSE, fig.height=7}
tbl_status %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(day, viral_load) +
	 	geom_hline(yintercept = 1e6) +
		geom_bar(aes(fill = symptomatic), stat = "identity", alpha = .66) +
		scale_y_log10() +
		ylab("viral load") +
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank()
		) + 
		labs(
			caption = "Random sample of VL trajectories with symptom status; black line indicates infectivity threshold."
		)
```

```{r, warning=FALSE, fig.height=7}
plt <- tbl_status %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(viral_load, sensitivity) +
		geom_point(aes(color = symptomatic)) +
		scale_x_log10() +
		xlab("viral load") +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank()
		) + 
		labs(
			caption = "Corresponding scatterplot of test sensitivity against VL (log scale); color corresponds to syptom status."
		)
ggExtra::ggMarginal(plt, type = "histogram", color = "darkgray", fill = "darkgray", size = 9)
```



# References
