---
title: "Modeling Test Sensitivity as Function of Viral Load"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

set.seed(42)
theme_set(
	theme_bw() + 
	theme(
		legend.position = "top",
		panel.grid.minor = element_blank(),
		legend.title = element_blank()
	)
)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
using cov19sim
import Random.seed!
seed!(42)
```



# Problem Statement

This document outlines a simple model for the sensitivity of a screening test
for Covid-19 as function of the latent viral load.



# Test Sensitivity as Function of Viral Load

Concerns about modeling the between-individual heterogeneity of test sensitivity
(see comments by J Deeks to [@kmietowicz2021a]) lead us to a random effects
logistic model for test sensitivity.

$$
\operatorname{sensitivity}(vl, u) := \operatorname{logit}^{-1}\Big( 
	\beta_{evl} \cdot \log_{10}\big( vl - \operatorname{LOD} \big) 
	+ \beta_{u}\cdot u
	+ c
\Big) \cdot \boldsymbol{1}_{\,vl\, \geq\, \operatorname{LOD}}
$$
where $vl$ is the viral load, $\operatorname{LOD}$ the limit of detection,
$u$ us an individuals latent 'testing random effect' $U\sim\mathcal{N}(0,1)$,
$\beta_{evl}, \beta_u$ are the model coefficients, and $c$ is the intercept.
We use log-10 excess viral load in analogy to the infection probability 
model proposed in [@larremore2020a].
The random effects allow a stronger temporal correlation of an individuals 
test results as compared to a model that only relies on the latent viral load
trajectories.



# Example

Looking at a sample of 25 disease trajectories, we can plot sensitivity as
function of viral load for an $\operatorname{LOD}$ of $1e5$ (just below infectivity), 
and $\beta_{evl} = 1.0, \beta_u = 0.5, c = -9.0$.

```{julia, results="hide"}
dm = LarremoreModel(.033)

# create individuals
individuals = [Individual(dm, 0.0) for i in 1:16] # no chance of non-covid symptoms
# infect them all
infect!.(individuals)
lfd = LogGLMTest("lfd", 1e5, 1.0, .5, -9.0, .997)
# simulate some days forward
for i in 1:45
	conduct_test!.(lfd, individuals)
    step!.(individuals)
end
conduct_test!.(lfd, individuals)

tbl_tests = get_test_logs(individuals)
tbl_status = get_status_logs(individuals)
```

```{r}
tbl_tests <- as_tibble(julia_eval("tbl_tests"))
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r, warning=FALSE}
tbl_status %>%
	mutate(
		symptomatic = factor(symptomatic, levels = c(FALSE, TRUE), labels = c("non-symptomatic", "symptomatic"))
	) %>%
	ggplot() +
		aes(day, viral_load) +
		geom_hline(yintercept = 1e5) +
	 	geom_hline(yintercept = 1e6, color = "gray") +
		geom_bar(aes(fill = symptomatic), stat = "identity", alpha = .66) +
		scale_y_log10() +
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) + 
		labs(
			y = "viral load",
			caption = "Random sample of VL trajectories with symptom status; black line indicates LOD; gray line indicates infectivity threshold."
		)
```

```{r, warning=FALSE}
tbl_tests %>%
	arrange(uuid, viral_load) %>%
	ggplot() +
		aes(viral_load, probability_positive, group = uuid) +
		geom_line(alpha = .33) +
		scale_x_log10() +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) + 
		labs(
			x = "viral load",
			y = "probability of positive test result",
			caption = "Individual sensitivity curves."
		)
```

```{r}
tbl_tests %>% 
	ggplot() +
		aes(day, probability_positive) +
		geom_bar(aes(y = as.numeric(result)), stat = "identity", fill = "gray") +
		geom_line() + 
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) + 
		labs(
			y = "probability of positive test result",
			caption = "Actual test-trajectories; gray bars correspond to positive test results; black line indicates probability of positive test result."
		)
```



# References
