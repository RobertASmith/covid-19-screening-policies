---
title: "Modeling Test Sensitivity as Function of Viral Load"
author: "Kevin Kunzmann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
bibliography: references.bib
---

```{r r-setup, include=FALSE}
library(JuliaCall)
library(tidyverse)

source("code/util.R")

knitr::opts_chunk$set(
	cache = TRUE,
	echo = FALSE,
	fig.width = 9,
	fig.height = 9/1.61
)

set.seed(42)
```

```{julia julia-setup, include=FALSE}
using Pkg
Pkg.activate(".julia")
using cov19sim
import Random.seed!
seed!(42)
```


$\newcommand{\vl}{\operatorname{VL}}$
$\newcommand{\lod}{\operatorname{LOD}}$


# Problem Statement

This document outlines a simple model for the sensitivity of a screening test
for Covid-19 as function of the latent viral load.



# Test Sensitivity as Function of Viral Load

Concerns about modeling the between-individual heterogeneity of test sensitivity
(see comments by J Deeks to [@kmietowicz2021a]) lead us to a random effects
logistic model for test sensitivity.

$$
\operatorname{sensitivity}(\operatorname{VL}, u) := \operatorname{logit}^{-1}\big( 
	\beta_{\operatorname{eVL}} \cdot \log_{10}( \operatorname{VL} ) 
	+ \beta_{u}\cdot u
	+ c_{\operatorname{test}}
\big)
$$
where $\operatorname{VL}$ is the viral load, $\operatorname{LOD}$ the limit of detection,
$u$ us an individuals latent 'testing random effect' $U\sim\mathcal{N}(0,1)$,
$\beta_{\operatorname{eVL}}, \beta_u$ are the model coefficients, and $c$ is the intercept.
We use log-10 excess viral load in analogy to the infection probability 
model proposed in [@larremore2020a].
The random effects allow a stronger temporal correlation of an individuals 
test results as compared to a model that only relies on the latent viral load
trajectories.



# Example

We calibrate the test sensitivity to data presented in 
http://modmedmicro.nsms.ox.ac.uk/wp-content/uploads/2021/01/infectivity_manuscript_20210119_merged.pdf
by screen-grabbing the Innova curve on page 22 of the PDF.

```{r plot-fit}
tbl_innova_data <- tibble(
	`viral load` = 10^(2:7),
	sensitivity = 1 - (c(621, 521, 344, 207, 144, 123) - 114) / (684 - 114)
)

sens <- function(vl, u = 0, beta_vl = 0.76, beta_u = 0.0, c = -3.81) {
	1 / (1 + exp(-(
		beta_vl*log(vl, 10) + beta_u*u + c
	)))
}

ff <- function(x) {
	sum( 
		(tbl_innova_data$sensitivity - 
		  	purrr::map_dbl(
		  		tbl_innova_data$`viral load`, 
		  		~sens(., u = 0, beta_vl = x[1], beta_u = 0, c = x[2])) 
		)^2
	)
}

res <- optim(
	c(.76, -5), ff,
	method = "L-BFGS-B",
	lower = c(.1, -10),
	upper = c(2.5, 5),
	control = list(maxit = 1e4)
)

julia_assign("beta_vl", res$par[1])
julia_assign("intercept", res$par[2])

plt <- tibble(
		`viral load` = 10^seq(0, 11, length.out = 1000),
		sensitivity = sens(`viral load`, u = 0, beta_vl = res$par[1], beta_u = 0.0, c = res$par[2])
	) %>%
	ggplot() +
		aes(`viral load`, sensitivity) +
		geom_line() +
		geom_point(data = tbl_innova_data) +
		scale_x_log10() + 
		scale_y_continuous("sensitivity", limits = c(0, 1)) +
		labs(
			caption = "Fitted Innova-LFD test sensitivity."
		)
save_plot(plt, "fit-sensitivity")
print(plt)
```

Since we use different studies to calibrate the disease model (Larremore) and
the test sensitivity profile, a plausibility check is in place.
We use a third data source, the [Liverpool community testing report](https://www.liverpool.ac.uk/media/livacuk/coronavirus/Liverpool,Community,Testing,Pilot,Interim,Evaluation.pdf)
to check the plausibility of the fitted sensitivity profile.
The Liverpool pilot found that the test sensitivity of the Innova test in a
practical setting was only 40%.
The study was based on *presymptomatic* individuals.
We can use this information by simulating a population of infected individuals
and randomly pick a pre-symptomatic time-point with a viral load of more than 
$10^2$ (assumed limit of detection for PCR) for each individual. 
The mean of the corresponding distribution of viral load values should then be
aligned with the Liverpool data.
Since this is not the case, we introduce a scaling factor to reconcile the
shape of the sensitivity curve found in the Oxford data with the mean sensitivity
of the real-world experiement from Liverpool, i.e., we consider 'scaled sensitivity'

\begin{align}
\operatorname{sensitivity}'(\operatorname{VL}, u) :&= \operatorname{logit}^{-1}\big( 
	\eta\cdot\beta_{\operatorname{eVL}} \cdot \log_{10}( \operatorname{VL} ) 
	+ \beta_{u}\cdot u
	+ c_{\operatorname{test}} \\
	&= \operatorname{logit}^{-1}\big( 
	\beta_{\operatorname{eVL}} \cdot \log_{10}\big( \operatorname{VL}^\eta \big) 
	+ \beta_{u}\cdot u
	+ c_{\operatorname{test}}
\big)
\end{align}

For a sample of $100,000$ under the Larremore et al model and $\beta_u=0.5$, 
the mean of the scaled sensitivity as function of $\eta$ is given below.

```{julia sample-individuals, results="hide"}
dm = LarremoreModel(
	0.25; # gamma; irrelevant here
    frac_symptomatic = 0.75,
    l10vl_onset = 3.0, day_onset_min = 2.5, day_onset_max = 3.5,
    l10vl_peak_min = 7.0, l10vl_peak_max = 11.0, peak_delay_max = 3.0, peak_delay_shape = 1.5,
	symptom_delay_min = 0.0, symptom_delay_max = 3.0,
    l10vl_clearance = 6.0, clearance_delay_min = 4.0, clearance_delay_max = 9.0
)

# create individuals
inds = [Individual(dm, 0.0) for i in 1:1e5] # no chance of non-covid symptoms
# infect them all
infect!.(inds)
# simulate some days forward
steps!.(inds, 30)
tbl_status = get_status_logs(inds)
```

```{r load-tbl-status}
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r}
tbl_vl <- tbl_status %>%
	arrange(uuid, day) %>%
	group_by(uuid) %>%
	filter(
		row_number() >= which(viral_load > 1e2)[1],
		row_number() < which(symptomatic)[1]
	) %>%
	sample_n(1) %>%
	ungroup() %>%
	select(uuid, day, viral_load)
```

```{r}
f <- function(fct) {
	tbl_vl %>% 
		mutate(
			sensitivity = sens(viral_load^fct, u = 0, beta_vl = res$par[1], beta_u = 0.5, c = res$par[2])
		) %>% 
		pull(sensitivity) %>% 
		summary() %>% 
		mean()
}

res2 <- uniroot(function(x) f(x) - 0.4, interval = c(0, 1))

tibble(
	exponent = seq(0, 2, length.out = 1000),
	`mean scaled sensitivity` = map_dbl(exponent, f)
) %>% 
ggplot() +
	aes(exponent, `mean scaled sensitivity`) +
	geom_hline(yintercept = 0.4, color = "darkgray") +
	geom_vline(xintercept = res2$root, color = "darkgray") +
	geom_line() +
	xlab(expression(eta))
```

Applying the identified $\eta=`r round(res2$root, 3)`$ yields the following 
relationship (the original control points are still plotted for reference):

```{r plot-refit}
plt <- tibble(
		`viral load` = 10^seq(0, 11, length.out = 1000),
		sensitivity = sens(`viral load`, u = 0, beta_vl = res$par[1], beta_u = 0.5, c = res$par[2]),
		`scaled sensitivity` = sens(`viral load`^(res2$root), u = 0, beta_vl = res$par[1], beta_u = 0.5, c = res$par[2])
	) %>%
	pivot_longer(
		-`viral load`
	) %>%
	ggplot() +
		aes(`viral load`, value) +
		geom_line(aes(linetype = name)) +
		geom_point(aes(y = sensitivity), data = tbl_innova_data) +
		scale_x_log10() +
		scale_y_continuous("", limits = c(0, 1)) +
		labs(
			caption = "Fitted Innova-LFD test sensitivity."
		)
save_plot(plt, "fit-sensitivity-2", height = 3.5) 
print(plt)
```


Looking at a sample of 16 disease trajectories, we can plot sensitivity as
function of viral load with the fitted (scaled) Innova parameters and no 
random effect. 

```{r}
JuliaCall::julia_assign("eta", res2$root)
```

```{julia sample, results="hide"}
dm = LarremoreModel(.25)

# create individuals
individuals = [Individual(dm, 0.0) for i in 1:16] # no chance of non-covid symptoms
# infect them all
infect!.(individuals)
lfd = LogRegTest("lfd", eta*beta_vl, .5, intercept, .998)
# simulate some days forward
for i in 1:45
	conduct_test!.(lfd, individuals)
    step!.(individuals)
end
conduct_test!.(lfd, individuals)

tbl_tests = get_test_logs(individuals)
tbl_status = get_status_logs(individuals)
```

```{r extract-results}
u <- julia_eval("[ind.dt.u for ind in individuals]")
tbl_tests <- as_tibble(julia_eval("tbl_tests"))
tbl_status <- as_tibble(julia_eval("tbl_status"))
```

```{r plot-sensitivity}
tbl_typical_sensitivity_curve <- tibble(
		u = 0,
		`viral load` = 10^seq(0, 11, length.out = 1000),
		sensitivity = sens(`viral load`, beta_vl = res$par[1], beta_u = 0.5, c = res$par[2])
	)

tbl_individual_sensitivity_curves <- expand_grid(
		u,
		`viral load` = 10^seq(0, 11, length.out = 1000),
	) %>%
	mutate(
		sensitivity = sens(`viral load`, u, beta_u = 0.5, beta_vl = res$par[1], c = res$par[2])
	)

plt <- ggplot(tbl_individual_sensitivity_curves) +
	aes(`viral load`, sensitivity, group = u) +
	geom_line(alpha = .33) +
	geom_line(data = tbl_typical_sensitivity_curve, color = "blue", size = 1.1) +
	scale_x_log10() +
	scale_y_continuous("sensitivity", limits = c(0, 1)) +
	labs(
		caption = "'Typical' (u = 0, blue) and sampled individual sensitivity functions."
	) +
	theme(
		panel.grid = element_blank()
	)
save_plot(plt, "sensitivity")
print(plt)
```

For each individual, the random effect $u$ slightly shifts the sensitivity curve.
The addition of the random effect means that the sensitivity curve for each individual
is either consistently lower or higher than the typical curve.
This in turn increases the temporal correlation of subsequent tests within the
same individual.
As a plausibility check, this can be visualized by plotting positive results of
a daily testing regime as vertical bars over the sensitivity trajectories.
The absolute value of the infection probability very much depends on the
chosen infectivity constant $\gamma$ within the Larremore disease model.

```{r plot-test-results}
plt <- tbl_tests %>%
	left_join(
		tbl_status %>%
			select(uuid, day, infection_probability),
		by = c("uuid", "day")
	) %>%
	pivot_longer(c(infection_probability, probability_positive)) %>%
	mutate(
		name = case_when(
				name == "infection_probability" ~ "infection probability",
				name == "probability_positive" ~ "probability of positive test",
			)
	) %>%
	ggplot() +
		aes(day, value) +
		geom_bar(aes(y = as.numeric(result)), stat = "identity", fill = "gray", position = position_identity()) +
		geom_line(aes(color = name)) +
		facet_wrap(~uuid) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) +
		labs(
			y = "",
			caption = "Positive test- and and infection probability over time; vertical bars = positive test (under daily testing)."
		)
save_plot(plt, "sensitivity-infectivity-test-results")
print(plt)
```

Yet another way of visualizing the correlation between infectivity and
test-sensitivity is by plotting each individuals infection and positive-test
probabilities in over time in a state-space diagram.

```{r plot-phase-diagram}
plt <- tbl_tests %>%
	left_join(
		tbl_status %>%
			select(uuid, day, infection_probability),
		by = c("uuid", "day")
	) %>%
	arrange(uuid, day) %>%
	ggplot() +
		aes(infection_probability, probability_positive) +
		geom_point(aes(color = uuid)) +
		geom_line(aes(color = uuid), alpha = .33) +
		coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
		theme(
			strip.text = element_blank(),
			strip.background = element_blank(),
			panel.grid = element_blank()
		) +
		labs(
			x = "infection probability",
			y = "probability of positive test result",
			caption = "Scatterplot of positive test- and infection probabilites; color corresponds to individuals."
		) +
		theme(
			legend.position = "none"
		)
save_plot(plt, "sensitivity-vs-infectivity")
print(plt)
```



# References
